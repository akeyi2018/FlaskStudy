## 1. プログラム名  
#### gpiozero_stepping.py  
---  
## 2. 処理概要  
#### ステッピングモーター（型番C28BYJ48）の制御を行う。  
##### ステッピングモーターの基礎知識に関しては[こちら](https://gitlab.com/raspberrypi_study/raspberrypistudy_basic/-/wikis/raspberrypistudy_basic.wiki/%E3%82%B9%E3%83%86%E3%83%83%E3%83%94%E3%83%B3%E3%82%B0%E3%83%A2%E3%83%BC%E3%82%BF%E3%83%BC)参照。  
---
## 3. 処理詳細  

### 3.1 インポートモジュール    　　
##### time: 時間操作用  
##### gpiozero: ステッピングモーター制御用  　　
---
### 3.2 クラス名  
#### C28BYJ48
### 3.3 メソッド一覧  
|No.|Name|説明|備考|  
|---|---|---|---|  
|1|コンストラクタ|GPIO番号・シーケンス番号・総ステップ数の初期化|初期化宣言で接続するGPIOをセットする|
|2|seq|スイッチシーケンスマットリックス|class内部使用|
|3|SetRoll|制御ステップ数・ステップの動作間隔時間の算出|class内部使用|
|4|SetPinVoltage|シーケンスビット列の生成(信号ピンの電圧は3V)|class内部使用|
|5|run|ステッピングモーター制御のメイン処理|外部から回転角度、撮影時間、回転方向を指示する|

---
#### 3.3.1 コンストラクタ
引数 ：
|No.|Name|説明|  
|---|---|---|  
|1|IN1|配線したGPIO番号指定|  
|2|IN2|配線したGPIO番号指定|
|3|IN3|配線したGPIO番号指定|
|4|IN4|配線したGPIO番号指定|

戻り値 ： 無し  

処理内容 ：  
1. ステッピングモーター制御用GPIO番号の初期化
2. シーケンス番号を初期化
3. 位相のステップ数の初期化（1-2相励磁：8 固定）
---

#### 3.3.2 seq  
引数 : 無し  
戻り値 :　スイッチシーケンスマットリックス  
詳細は[datasheet](https://datasheetspdf.com/pdf-file/1167005/FullingMotor/28BYJ48-12-300-01/1)参照  
処理内容 :  
スイッチシーケンスマットリックスの設定 


#### 3.3.3 SetRoll  
引数 :
|No.|Name|型|説明|  
|---|---|---|---|  
|1|angle|int|入力角度(deg)|  
|2|wait|int|インターバル撮影のトータル時間(分)|  

戻り値 :
|No.|Name|型|説明|  
|---|---|---|---|  
|1|steps|int|制御ステップ数|  
|2|interval|float|ステップの動作間隔時間|  

処理内容 :
1. 角度が0以下の場合は、戻り値0とし、runメソッドにおいて処理がスキップされる。
2. 制御ステップ数は、本モータのギヤ比特性により、回転に必要なステップ数は以下の式で求められる。  

[ステップ数] = [入力角度 * 2] * [360度回転するためのステップ数] / 360  
[入力角度 * 2] : ステッピングモーターの外側にカメラ回転台のギア比2：1があるため、角度入力値を2倍にしている    
[360度回転するためのステップ数] : [datasheet](https://datasheetspdf.com/pdf-file/1167005/FullingMotor/28BYJ48-12-300-01/1)より、ギヤ比1/64,ステップ角度は5.625度(deg)/64であるため、360度回転するためのステップ数は4096となる  

3. ステップの動作間隔時間の計算は、以下の式で求められる  

[ステップの動作間隔時間] = [インターバル撮影のトータル時間(分）* 60] / [ステップ数]   

[インターバル撮影のトータル時間(分）* 60] ： 入力値分単位を秒単位へ変換する  
[ステップ数] : 上記の式で求めた値  

---

#### 3.3.4 SetPinVoltage

引数 :
|No.|Name|説明|  
|---|---|---|  
|1|Nseq|シーケンス番号|  

戻り値 : 無し  

処理内容 :
1. 制御するステップのシーケンス番号を読み取る 
2. ステッピングモーターの4本の制御用信号線（GPIO）に対して、信号のON/OFFをセットする(ONの場合の電圧は3V/OFFの場合は0V)  

#### 3.3.5 run

引数 :
|No.|Name|型|説明|  
|---|---|---|---|  
|1|angle|int|入力角度(deg)|  
|2|wait|int|インターバル撮影のトータル時間(分)|
|3|direction|int|回転方向|

戻り値 : 無し  
処理内容 
1. 時計回りか反時計回りかの値をセット
2. 制御に必要なステップ数とステップの動作時間間隔を計算する
3. 制御ステップ数で以下を繰り返す  
 3.1 ステッピングモーター制御のスイッチシーケンスを読み取り、信号のON/OFFをセットする  
 3.2 制御開始のシーケンス番号をセットする  
 3.3 スイッチのシフト操作  
 　スイッチのシーケンス番号は回転方向によって右または左にシフトされるが、カメラ台座のギヤを拡張したため、[datasheet](https://datasheetspdf.com/pdf-file/1167005/FullingMotor/28BYJ48-12-300-01/1)と真逆となる。
　　　・時計方向　→　-1  
　　　・反時計方向　→　+1  
 3.4 時計回りの場合、シーケンス番号が最大になったら0に戻す。  
 3.5 反時計周りの場合は、シーケンス番号がマイナスになった時点で、元に戻す。  
4. 制御の休止間隔でSleep
---

### 3.4 外部インターフェース   

#### 3.4.1 インスタンス宣言    
     
GPIOは4本が必要で、配線に合わせてGPIOの番号は適宜に変更する事
```
StepMotor = C28BYJ48(12,16,20,21) 
```  

#### 3.4.2 実行事例：  
時計周り180度回転で撮影時間1分の場合は  

```
StepMotor.run(180, 1, 1)  
```  
